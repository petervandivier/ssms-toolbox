{
  "id": "7dca226b-7563-4e5b-9012-1ddf39a8a3ec",
  "prefix": "xpert",
  "description": "cache xp_readerrorlog to table & selectively exclude log spam",
  "body": "\ndrop table if exists #xper;\ncreate table #xper (\n    id int identity primary key, \n    LogNo tinyint, \n    LogDate datetime, \n    ProcessInfo nvarchar(12), \n    [Text] nvarchar(850) index x_text -- max NCI key length 1700 bytes\n);\n\ndeclare @i tinyint = 0;\nwhile @i < 3\nbegin;\n    insert #xper (LogDate, ProcessInfo, [Text])\n    exec xp_readerrorlog @i;\n    update #xper set LogNo = @i where LogNo is null; \n    set @i += 1;\nend;\n--select count(*) from #xper\n\nselect \n    est = LogDate at time zone 'UTC' at time zone 'Eastern Standard Time',\n    * ,\n    ','''+replace(left([Text],21),'''','''''')+'''' as ExcludeStub\nfrom #xper\nwhere -- LogDate >= '$DATE$' and \n    left([Text],21) not in (\n         '[INFO] Database ID: [' -- SB spam\n        ,'DBCC TRACEOFF 3604, s' -- SQLPrompt\n        ,'DBCC TRACEON 3604, se' -- SQLPrompt\n        ,'The activated proc ''[' -- moar SB spam\n        ,'SQL Trace stopped. Tr'\n    )\n-- select top(1) [text] from sys.messages where language_id = 1033 and message_id = 33308\n    and [Text] not like 'The queue % in database % has activation enabled and contains unlocked messages but no RECEIVE has been executed for % seconds.' -- SB spam\n    and [Text] not like 'SQL Trace ID % was st%'\norder by LogDate desc, id desc;\n\n"
}