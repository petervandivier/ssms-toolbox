{
  "id": "fb879ae7-22be-4819-9201-7d8e9b6eb781",
  "prefix": "spaceused_better",
  "description": "text format sp_spaceused",
  "body": "\r\ndrop table if exists #spaceused;\r\ncreate table #spaceused (\r\n    table_name       sysname,\r\n    [rows]           bigint,\r\n    reserved         nvarchar(128) not null,\r\n    [data]           nvarchar(128) not null,\r\n    index_size       nvarchar(128) not null,\r\n    unused           nvarchar(128) not null,\r\n    rows_int64       as try_convert(bigint,left([rows]    ,len([rows]    )-3)),\r\n    reserved_int64   as try_convert(bigint,left(reserved  ,len(reserved  )-3)),\r\n    data_int64       as try_convert(bigint,left([data]    ,len([data]    )-3)),\r\n    index_size_int64 as try_convert(bigint,left(index_size,len(index_size)-3)),\r\n    unused_int64     as try_convert(bigint,left(unused    ,len(unused    )-3)),\r\n    rows_text        nvarchar(128),\r\n    reserved_text    nvarchar(128),\r\n    data_text        nvarchar(128),\r\n    index_size_text  nvarchar(128),\r\n    unused_text      nvarchar(128),\r\n);\r\n\r\ninsert into #spaceused (\r\n    table_name,\r\n    [rows],\r\n    reserved,\r\n    [data],\r\n    index_size,\r\n    unused     \r\n)\r\nexec sp_spaceused '$CURSOR$'\r\n\r\n--select \r\n--    format([rows],'N0'),\r\n--    (len(reserved)-3)/3,\r\n--    * \r\n--from #spaceused;\r\n\r\nupdate #spaceused set\r\n    rows_text     = format([rows],'N0'),\r\n    reserved_text = \r\n        case ceiling((len(reserved)-3.0)/3)\r\n            when 1 then lower(replace(reserved,' ',''))\r\n            when 2 then concat(format(round(reserved_int64/1000.0,2)      ,'N1'),'mb')\r\n            when 3 then concat(format(round(reserved_int64/1000000.0,2)   ,'N1'),'gb')\r\n            when 4 then concat(format(round(reserved_int64/1000000000.0,2),'N1'),'tb')\r\n        end,\r\n    data_text = \r\n        case ceiling((len([data])-3.0)/3)\r\n            when 1 then lower(replace([data],' ',''))\r\n            when 2 then concat(format(round(data_int64/1000.0,2)      ,'N1'),'mb')\r\n            when 3 then concat(format(round(data_int64/1000000.0,2)   ,'N1'),'gb')\r\n            when 4 then concat(format(round(data_int64/1000000000.0,2),'N1'),'tb')\r\n        end,\r\n    index_size_text = \r\n        case ceiling((len(index_size)-3.0)/3)\r\n            when 1 then lower(replace(index_size,' ',''))\r\n            when 2 then concat(format(round(index_size_int64/1000.0,2)      ,'N1'),'mb')\r\n            when 3 then concat(format(round(index_size_int64/1000000.0,2)   ,'N1'),'gb')\r\n            when 4 then concat(format(round(index_size_int64/1000000000.0,2),'N1'),'tb')\r\n        end,\r\n    unused_text = \r\n        case ceiling((len(unused)-3.0)/3)\r\n            when 1 then lower(replace(unused,' ',''))\r\n            when 2 then concat(format(round(unused_int64/1000.0,2)      ,'N1'),'mb')\r\n            when 3 then concat(format(round(unused_int64/1000000.0,2)   ,'N1'),'gb')\r\n            when 4 then concat(format(round(unused_int64/1000000000.0,2),'N1'),'tb')\r\n        end\r\n;\r\n\r\n--select \r\n--    (len([data])-3)/3,\r\n--    round(data_int64/1000.0,2),\r\n--    * \r\n--from #spaceused\r\n\r\nselect\r\n    table_name,\r\n    rows_text,\r\n    reserved_text,\r\n    data_text,\r\n    index_size_text,\r\n    unused_text\r\nfrom #spaceused;\r\ngo\r\nselect\r\n    [property],\r\n    [value]\r\nfrom #spaceused as s\r\nunpivot (\r\n    [value] for [property] in (\r\n        table_name,\r\n        rows_text,\r\n        reserved_text,\r\n        data_text,\r\n        index_size_text,\r\n        unused_text\r\n    )\r\n) as pvt\r\ngo\r\n\r\n"
}